<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Compras</title>
  <style>
    :root{
      --bg:#f7f9fb; --paper:#ffffff; --ink:#0f172a; --muted:#6b7280; --ring: 0 0 0 3px rgba(16,185,129,.18);
      --primary:#10b981; --primary-ink:#065f46; --danger:#ef4444; --border:#e5e7eb; --chip:#edf2f7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--ink)}
    .app{max-width:860px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}

    /* Topbar */
    .topbar{position:sticky;top:0;background:var(--paper);border-bottom:1px solid var(--border);z-index:5}
    .topbar .inner{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,#34d399,#10b981);display:grid;place-items:center;color:white;font-weight:800}
    .brand h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted)}

    /* Filters */
    .filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px 16px;background:var(--paper);border-bottom:1px solid var(--border)}
    .chip{appearance:none;border:none;cursor:pointer;background:var(--chip);color:#374151;padding:8px 12px;border-radius:999px;font-weight:600}
    .chip[aria-pressed="true"]{background:#d1fae5;color:#065f46}
    .search{margin-left:auto;display:flex;gap:8px}
    .search input{padding:10px 12px;border:1px solid var(--border);border-radius:10px}

    /* List */
    .list{padding:8px 12px 90px}
    .row{background:var(--paper);border:1px solid var(--border);border-radius:16px;display:grid;grid-template-columns:42px 1fr auto;align-items:center;gap:10px;padding:12px 14px;margin:8px 4px;box-shadow:0 6px 20px rgba(2,6,23,.04)}
    .check{appearance:none;width:22px;height:22px;border-radius:999px;border:2px solid #059669;display:grid;place-items:center;cursor:pointer}
    .check:checked{background:var(--primary);border-color:var(--primary)}
    .meta{display:flex;flex-direction:column;gap:4px}
    .name{font-size:16px;font-weight:700;border:0;background:transparent;outline:none}
    .subline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{font-size:12px;background:#eef2ff;color:#3730a3;padding:4px 8px;border-radius:999px}
    .qty,.price{width:90px;text-align:right;padding:6px 8px;border:1px solid var(--border);border-radius:10px}
    .right{display:flex;align-items:center;gap:8px}
    .row.done{opacity:.6}
    .row.done .name{text-decoration:line-through}

    .row .icon{background:transparent;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer}
    .row .icon.danger{border-color:#fecaca;color:#991b1b}

    .empty{padding:28px;color:var(--muted);text-align:center}

    /* Bottom add bar (inspired by community kits) */
    .addbar{position:fixed;left:0;right:0;bottom:0;background:var(--paper);border-top:1px solid var(--border);padding:12px 12px;z-index:10}
    .addgrid{max-width:860px;margin:0 auto;display:grid;grid-template-columns:1.4fr .6fr .7fr .8fr auto;gap:8px}
    .addgrid input, .addgrid select{padding:12px;border:1px solid var(--border);border-radius:12px;outline:none}
    .addgrid input:focus, .addgrid select:focus{box-shadow:var(--ring);border-color:#a7f3d0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 14px;border-radius:12px;border:1px solid #34d399;background:linear-gradient(180deg,#34d399,#10b981);color:white;font-weight:700;cursor:pointer}

    .toolbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--paper);border-bottom:1px solid var(--border)}
    .toolbar button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#f8fafc;cursor:pointer}
    .toolbar .danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}

    @media (max-width:720px){
      .addgrid{grid-template-columns:1fr .6fr .7fr auto}
      .addgrid select:nth-child(4){display:none}
      .qty,.price{width:78px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="inner">
        <div class="brand">
          <div class="logo">ðŸ›’</div>
          <div>
            <h1>Lista de compras</h1>
            <div class="sub" id="stamp"></div>
          </div>
        </div>
        <div class="sub" id="summary">0 itens â€¢ R$ 0,00</div>
      </div>
      <div class="filters">
        <button class="chip" data-chip value="">Todos</button>
        <button class="chip" data-chip value="Hortifruti">Hortifruti</button>
        <button class="chip" data-chip value="AÃ§ougue">AÃ§ougue</button>
        <button class="chip" data-chip value="Padaria">Padaria</button>
        <button class="chip" data-chip value="Limpeza">Limpeza</button>
        <div class="search">
          <input id="search" type="search" placeholder="Buscar itemâ€¦" />
        </div>
      </div>
      <div class="toolbar">
        <button id="markAll">Marcar tudo</button>
        <button id="clearDone">Limpar comprados</button>
        <button id="reset" class="danger">Zerar lista</button>
        <button id="exportBtn">Exportar</button>
        <button id="importBtn">Importar</button>
        <select id="sortBy" style="margin-left:auto">
          <option value="name">Ordenar: Nome</option>
          <option value="cat">Ordenar: Categoria</option>
          <option value="price">Ordenar: PreÃ§o</option>
          <option value="qty">Ordenar: Quantidade</option>
          <option value="done">Ordenar: Pendentes primeiro</option>
        </select>
      </div>
    </div>

    <div id="list" class="list" role="list"></div>

    <!-- Bottom Add Bar -->
    <form id="addForm" class="addbar" autocomplete="off">
      <div class="addgrid">
        <input id="name" type="text" placeholder="Adicionar item (ex: Leite integral)" required />
        <input id="qty" type="number" step="1" min="1" placeholder="Qtd" value="1" />
        <input id="price" type="number" step="0.01" min="0" placeholder="PreÃ§o" />
        <select id="cat">
          <option value="Geral">Geral</option>
          <option>Hortifruti</option>
          <option>AÃ§ougue</option>
          <option>Padaria</option>
          <option>LaticÃ­nios</option>
          <option>Bebidas</option>
          <option>Limpeza</option>
          <option>Higiene</option>
        </select>
        <button class="btn" type="submit">Adicionar</button>
      </div>
    </form>
  </div>

  <template id="rowTmpl">
    <div class="row" data-id="">
      <input class="check" type="checkbox" aria-label="Marcar comprado" />
      <div class="meta">
        <input class="name" />
        <div class="subline">
          <span class="pill cat"></span>
        </div>
      </div>
      <div class="right">
        <input class="qty" type="number" min="1" step="1" />
        <input class="price" type="number" min="0" step="0.01" />
        <button class="icon del danger" title="Excluir">Excluir</button>
      </div>
    </div>
  </template>

  <input id="filePicker" type="file" accept="application/json" hidden />

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const LS_KEY = 'shopping-list-v3';
    let state = load();

    $('#stamp').textContent = new Intl.DateTimeFormat('pt-BR',{dateStyle:'medium'}).format(new Date());

    const listEl = $('#list');
    const tmpl = $('#rowTmpl');

    function load(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {items:[]} }catch(e){ return {items:[]} }
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    // Chips (filtro por categoria)
    let chipFilter = '';
    $$('[data-chip]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        chipFilter = btn.value;
        $$('[data-chip]').forEach(b=>b.setAttribute('aria-pressed', String(b===btn)));
        render();
      })
    });

    // Add item (bottom bar)
    $('#addForm').addEventListener('submit', e=>{
      e.preventDefault();
      const name = $('#name').value.trim();
      if(!name) return;
      const it = {
        id: crypto.randomUUID(),
        name,
        qty: Number($('#qty').value || 1),
        price: Number($('#price').value || 0),
        cat: $('#cat').value || 'Geral',
        done:false,
        ts: Date.now()
      };
      state.items.push(it);
      e.target.reset();
      $('#qty').value = 1;
      render();
      $('#name').focus();
    });

    function render(){
      applySort();
      listEl.innerHTML = '';
      const q = $('#search').value.toLowerCase();
      const items = state.items.filter(i=>
        (!q || i.name.toLowerCase().includes(q)) && (!chipFilter || i.cat===chipFilter)
      );
      if(!items.length){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'Nenhum item ainda. Use a barra inferior para adicionar.';
        listEl.appendChild(empty); updateSummary(); return;
      }
      for(const it of items){
        const row = tmpl.content.firstElementChild.cloneNode(true);
        row.dataset.id = it.id;
        row.classList.toggle('done', !!it.done);
        $('.check',row).checked = !!it.done;
        $('.name',row).value = it.name;
        $('.qty',row).value = it.qty;
        $('.price',row).value = it.price?.toFixed?.(2) ?? it.price;
        $('.cat',row).textContent = it.cat || 'Geral';

        $('.check',row).addEventListener('change', ev=>{ it.done = ev.target.checked; save(); updateSummary(); row.classList.toggle('done', it.done); });
        $('.name',row).addEventListener('change', ev=>{ it.name = ev.target.value.trim(); save(); });
        $('.qty',row).addEventListener('change', ev=>{ it.qty = Math.max(1, Number(ev.target.value||1)); save(); updateSummary(); });
        $('.price',row).addEventListener('change', ev=>{ it.price = Math.max(0, Number(ev.target.value||0)); save(); updateSummary(); });
        $('.del',row).addEventListener('click', ()=>{ state.items = state.items.filter(x=>x.id!==it.id); render(); });

        listEl.appendChild(row);
      }
      updateSummary();
      save();
    }

    // Totais compactos na topbar
    function updateSummary(){
      const all = state.items;
      const total = all.reduce((s,i)=> s + (Number(i.price)||0) * (Number(i.qty)||1), 0);
      $('#summary').textContent = `${all.length} itens â€¢ R$ ${new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}).format(total)}`;
    }

    // OrdenaÃ§Ã£o
    function applySort(){
      const by = $('#sortBy').value;
      const cmp = new Intl.Collator('pt-BR',{numeric:true, sensitivity:'base'}).compare;
      const fns = {
        name:(a,b)=> cmp(a.name,b.name),
        cat:(a,b)=> cmp(a.cat||'', b.cat||''),
        price:(a,b)=> (a.price||0)-(b.price||0),
        qty:(a,b)=> (a.qty||0)-(b.qty||0),
        done:(a,b)=> Number(a.done)-Number(b.done)
      };
      state.items.sort(fns[by]||fns.name);
    }

    // Bulk actions
    $('#markAll').addEventListener('click', ()=>{ state.items.forEach(i=>i.done=true); render(); });
    $('#clearDone').addEventListener('click', ()=>{ state.items = state.items.filter(i=>!i.done); render(); });
    $('#reset').addEventListener('click', ()=>{ if(confirm('Apagar toda a lista?')){ state={items:[]}; save(); render(); }});

    // Search & sort
    $('#search').addEventListener('input', render);
    $('#sortBy').addEventListener('change', render);

    // Export/Import JSON
    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'lista-compras.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    const picker = $('#filePicker');
    $('#importBtn').addEventListener('click', ()=> picker.click());
    picker.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.items)) throw new Error('Formato invÃ¡lido');
        state = {items: data.items.map(it=>({id: it.id||crypto.randomUUID(), name:String(it.name||'Item'), qty:Number(it.qty||1), price:Number(it.price||0), cat:String(it.cat||'Geral'), done: !!it.done, ts: it.ts||Date.now()}))};
        render();
      }catch(err){ alert('Falha ao importar: ' + err.message); }
      e.target.value='';
    });

    render();
  </script>
</body>
</html>
